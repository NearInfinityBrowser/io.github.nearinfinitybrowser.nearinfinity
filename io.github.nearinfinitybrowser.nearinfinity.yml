app-id: io.github.nearinfinitybrowser.nearinfinity
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
command: nearinfinity

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --socket=cups
  # Required to access game folders outside of $HOME
  - --filesystem=host
  # Required to make game assets temporarily available to associated applications (e.g. video files)
  - --filesystem=/tmp
  - --env=PATH=/usr/bin:/app/bin:/app/jre/bin
  - --env=JAVA_HOME=/app/jre

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh

  - name: nearinfinity
    buildsystem: simple
    build-commands:
      - install -Dm755 nearinfinity "${FLATPAK_DEST}/bin/nearinfinity"
      - install -Dm644 NearInfinity.jar "${FLATPAK_DEST}/share/NearInfinity.jar"
      - install -Dm644 "${FLATPAK_ID}.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      - install -Dm644 "${FLATPAK_ID}.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - install -Dm644 App256.png "${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png"
      - install -Dm644 "${FLATPAK_ID}-key.xml" "${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}-key.xml"
      - install -Dm644 "${FLATPAK_ID}-key-22.png" "${FLATPAK_DEST}/share/icons/hicolor/22x22/mimetypes/${FLATPAK_ID}-key.png"
      - install -Dm644 "${FLATPAK_ID}-key-256.png" "${FLATPAK_DEST}/share/icons/hicolor/256x256/mimetypes/${FLATPAK_ID}-key.png"
    sources:
      - type: script
        dest-filename: nearinfinity
        commands:
          - exec java -jar /app/share/NearInfinity.jar -no-update -no-launch-game "$@"
      - type: file
        path: io.github.nearinfinitybrowser.nearinfinity.desktop
      - type: file
        path: ./mime/io.github.nearinfinitybrowser.nearinfinity-key.xml
      - type: file
        path: ./mime/io.github.nearinfinitybrowser.nearinfinity-key-22.png
      - type: file
        path: ./mime/io.github.nearinfinitybrowser.nearinfinity-key-256.png
      - type: file
        url: https://github.com/NearInfinityBrowser/NearInfinity/raw/master/src/org/infinity/icon/App256.png
        sha256: 6cedf31382cd00c6b8aa2dae73069f1b569490f463cbaad4823094d535ef19bc
      - type: file
        path: io.github.nearinfinitybrowser.nearinfinity.metainfo.xml
      - type: archive
        url: https://github.com/Argent77/NearInfinity/releases/download/v2.3-20230610/NearInfinity-20230610.zip
        sha256: 8aeaccfbdae4e4f659630f7b5b5b87a95629460ded09fa77b032cd7d0e9891ba
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Argent77/NearInfinity/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name | match("^NearInfinity(-v?\\d+(\\.\\d+)*)?(-\\d+(-.+)?)?\\.zip$"; "i")) | .browser_download_url
